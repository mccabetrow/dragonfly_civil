# ---------------------------------------------------------------------------
# Supabase Migrations Workflow (Dragonfly Civil)
# ---------------------------------------------------------------------------
# Purpose
#   Apply all pending Supabase migrations automatically on:
#     - push to main (when migrations change)  -> applies to DEV
#     - manual trigger with environment input  -> applies to DEV or PROD
#
# Required GitHub Secrets
#   SUPABASE_DB_URL_DEV    : Direct PostgreSQL connection string for DEV
#   SUPABASE_DB_URL_PROD   : Direct PostgreSQL connection string for PROD
#   DISCORD_WEBHOOK_URL    : Discord webhook for failure alerts
#
# IMPORTANT
#   - NEVER use --linked, supabase link, or pooler hostnames
#   - ALWAYS use --db-url with explicit connection strings
#   - Uses 'migration up' instead of 'db push' for reliability
# ---------------------------------------------------------------------------

name: Supabase Migrations

on:
  push:
    branches: [main]
    paths:
      - "supabase/migrations/**"
      - ".github/workflows/supabase-migrate.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - prod

permissions:
  contents: read

concurrency:
  group: supabase-migrations-${{ github.event.inputs.environment || 'dev' }}
  cancel-in-progress: false # Never cancel in-progress migrations

env:
  SUPABASE_PROJECT_REF: ejiddanxtqcleyswqvkc

jobs:
  migrate:
    name: Apply Migrations (${{ github.event.inputs.environment || 'dev' }})
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Determine DB URL
        id: db-url
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          if [ "$ENV" = "prod" ]; then
            echo "db_url_secret=SUPABASE_DB_URL_PROD" >> $GITHUB_OUTPUT
          else
            echo "db_url_secret=SUPABASE_DB_URL_DEV" >> $GITHUB_OUTPUT
          fi

      - name: Validate DB URL is set
        env:
          DB_URL: ${{ secrets[steps.db-url.outputs.db_url_secret] }}
        run: |
          if [ -z "$DB_URL" ]; then
            echo "::error::${{ steps.db-url.outputs.db_url_secret }} secret is not configured"
            exit 1
          fi
          echo "‚úÖ ${{ steps.db-url.outputs.db_url_secret }} is configured"

      - name: Show migration status (before)
        env:
          DB_URL: ${{ secrets[steps.db-url.outputs.db_url_secret] }}
        run: |
          echo "üìã Migration status for ${{ steps.db-url.outputs.environment }}:"
          supabase migration list --db-url "$DB_URL"

      - name: Count pending migrations
        id: pending
        env:
          DB_URL: ${{ secrets[steps.db-url.outputs.db_url_secret] }}
        run: |
          set -euo pipefail
          echo "üìä Checking pending migrations..."
          OUTPUT=$(supabase migration list --db-url "$DB_URL")
          echo "$OUTPUT"
          # Count lines where Remote column is empty (pending migrations)
          PENDING=$(echo "$OUTPUT" | grep -cE '^\s*[0-9]+\s*\|\s*\|' || echo "0")
          echo "count=$PENDING" >> $GITHUB_OUTPUT
          echo "üìä Pending migrations: $PENDING"

      - name: Apply pending migrations
        if: steps.pending.outputs.count != '0'
        env:
          DB_URL: ${{ secrets[steps.db-url.outputs.db_url_secret] }}
        run: |
          set -euxo pipefail
          echo "üöÄ Applying ${{ steps.pending.outputs.count }} migration(s) to ${{ steps.db-url.outputs.environment }}..."
          echo "   Using: supabase migration up --db-url --include-all"
          # --include-all: Apply out-of-order local migrations that predate the last remote migration
          supabase migration up --db-url "$DB_URL" --include-all
          echo "‚úÖ Migrations applied successfully"

      - name: Skip if no pending migrations
        if: steps.pending.outputs.count == '0'
        run: echo "‚úÖ No pending migrations to apply"

      - name: Show migration status (after)
        env:
          DB_URL: ${{ secrets[steps.db-url.outputs.db_url_secret] }}
        run: |
          set -euo pipefail
          echo "üìã Final migration status for ${{ steps.db-url.outputs.environment }}:"
          supabase migration list --db-url "$DB_URL"
          echo ""
          echo "‚úÖ All migrations are now applied."

      - name: Verify critical views exist
        env:
          DB_URL: ${{ secrets[steps.db-url.outputs.db_url_secret] }}
        run: |
          set -euo pipefail
          echo "üîç Verifying critical views..."
          psql "$DB_URL" --set ON_ERROR_STOP=1 -c "
            SELECT 'enforcement.v_radar' AS view, EXISTS(SELECT 1 FROM pg_views WHERE schemaname='enforcement' AND viewname='v_radar') AS exists
            UNION ALL
            SELECT 'enforcement.v_score_card', EXISTS(SELECT 1 FROM pg_views WHERE schemaname='enforcement' AND viewname='v_score_card')
            UNION ALL
            SELECT 'ops.v_enrichment_health', EXISTS(SELECT 1 FROM pg_views WHERE schemaname='ops' AND viewname='v_enrichment_health');
          "
          echo "‚úÖ Critical views verified"

      - name: üö® Notify Discord on Failure
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "üö® CRITICAL: Database Migration FAILED (${{ steps.db-url.outputs.environment }})"
          description: "Migration to ${{ steps.db-url.outputs.environment }} failed. Check logs immediately.\n\nüëâ [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          color: 0xFF0000

      - name: ‚úÖ Notify Discord on Success (prod only)
        if: success() && steps.db-url.outputs.environment == 'prod'
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "‚úÖ Production Migration Complete"
          description: "Applied ${{ steps.pending.outputs.count }} migration(s) to production."
          color: 0x00FF00
