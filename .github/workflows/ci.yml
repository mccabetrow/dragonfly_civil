name: CI

on:
  workflow_call:
    secrets:
      SUPABASE_URL:
        required: false
      SUPABASE_SERVICE_ROLE_KEY:
        required: false
      SUPABASE_DB_URL:
        required: false
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
    inputs:
      run_integration:
        description: "Run integration tests"
        required: false
        default: false
        type: boolean

jobs:
  # ===========================================================================
  # Unit Tests - Run on every push/PR
  # ===========================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Run unit tests (excluding integration)
        env:
          # Dummy values for pydantic Settings validation during import
          SUPABASE_URL: "https://placeholder.supabase.co"
          SUPABASE_SERVICE_ROLE_KEY: "placeholder-key-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
          SUPABASE_DB_URL: "postgresql://placeholder:placeholder@localhost:5432/placeholder"
          SUPABASE_PROJECT_REF: "placeholder"
        run: pytest -q -m "not integration and not e2e" --tb=short

  # ===========================================================================
  # Secret Detection - MUST PASS BEFORE ANY OTHER JOB
  # ===========================================================================
  secrets-scan:
    name: Secret Detection
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for gitleaks

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml

  # ===========================================================================
  # Frontend Security Scan - blocks PRs that leak secrets to Vite builds
  # ===========================================================================
  frontend-security:
    name: Frontend Security Gate
    runs-on: ubuntu-latest
    needs: secrets-scan

    defaults:
      run:
        working-directory: dragonfly-dashboard

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: dragonfly-dashboard/package-lock.json

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: npm ci

      - name: Run frontend security checks
        env:
          VITE_API_BASE_URL: "https://ci.dragonfly.app/api"
          VITE_SUPABASE_URL: "https://placeholder.supabase.co"
          VITE_SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlhdCI6MTYwOTk5OTk5OX0.dummy_signature_ci"
          VITE_DRAGONFLY_API_KEY: "df_prod_ci_placeholder"
          VITE_DASHBOARD_SOURCE: "ci"
        run: npm run check-security

  # ===========================================================================
  # Lint & Format Check
  # ===========================================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          python -m pip install ruff black isort

      - name: Run ruff (fast linter)
        run: ruff check .

      - name: Run black (format check)
        run: black --check .

      - name: Run isort (import order)
        run: isort --check-only .

  # ===========================================================================
  # Integration Tests - Run on main or manual trigger
  # ===========================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    # Run on main branch or when manually triggered with run_integration=true
    if: github.ref == 'refs/heads/main' || github.event.inputs.run_integration == 'true'
    needs: [unit-tests, lint, secrets-scan]

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Run integration tests
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "⚠️ Supabase secrets not configured - skipping integration tests"
            exit 0
          fi
          pytest -q -m "integration" --tb=short

      - name: Run smoke test
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "⚠️ Skipping smoke test - Supabase secrets not configured"
            exit 0
          fi
          python -m tools.smoke

  # ===========================================================================
  # Dashboard Build Check
  # ===========================================================================
  dashboard-build:
    name: Dashboard Build
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: dragonfly-dashboard

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: dragonfly-dashboard/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run typecheck || echo "Typecheck not configured"

      - name: Build
        run: npm run build
