name: production_deploy

# =============================================================================
# DEPLOY POLICY
# =============================================================================
# This workflow deploys to production AFTER CI passes.
# - Full unit test suite runs in CI (ci.yml, dragonfly-ci.yml)
# - Deploy jobs assume CI is green and only run migrations + deploy
# - Integration tests are quarantined and run separately (not in CI or deploy)
#
# To run integration tests locally:
#   SUPABASE_MODE=prod pytest -m integration tests/
#
# To run integration tests in CI, trigger the CI workflow manually with
# run_integration=true, or create a dedicated integration workflow.
# =============================================================================

on:
  push:
    branches: [main]
  workflow_dispatch: {}

# Prevent concurrent deploys to avoid race conditions
concurrency:
  group: production-deploy
  cancel-in-progress: false

jobs:
  # ---------------------------------------------------------------------------
  # Wait for CI to pass before deploying
  # ---------------------------------------------------------------------------
  ci-gate:
    name: Wait for CI
    runs-on: ubuntu-latest
    steps:
      - name: CI gate placeholder
        run: |
          echo "CI workflows run in parallel on push to main."
          echo "Deploy proceeds assuming CI is green."
          echo "If CI fails, the deploy will be superseded by the fix commit."

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [ci-gate]
    timeout-minutes: 15

    env:
      # Phase tracking for failure notifications
      PHASE: "init"

      # Supabase
      SUPABASE_DB_URL_PROD: ${{ secrets.SUPABASE_DB_URL_PROD }}
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}

      # App deploy targets
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      VERCEL_DEPLOY_WEBHOOK: ${{ secrets.VERCEL_DEPLOY_WEBHOOK }}

      # Notifications
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # SETUP PHASE
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: "requirements.txt"

      - name: Cache npm packages
        id: cache-npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-cli-tools-v3
          restore-keys: |
            ${{ runner.os }}-npm-cli-tools-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Install Railway CLI
        run: |
          npm install -g @railway/cli
          echo "âœ“ Supabase CLI: $(supabase --version)"
          echo "âœ“ Railway CLI: $(railway --version)"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # NOTE: Tests are handled by CI workflows (ci.yml, dragonfly-ci.yml)
      # Deploy assumes CI is green. No test phase here.
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # PHASE: MIGRATIONS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Phase: Migrations"
        run: echo "PHASE=migrations" >> $GITHUB_ENV

      - name: Validate PROD secrets
        if: success()
        run: |
          if [ -z "$SUPABASE_DB_URL_PROD" ]; then
            echo "::error::SUPABASE_DB_URL_PROD is not set"
            exit 1
          fi
          if [ -z "$SUPABASE_PROJECT_REF" ]; then
            echo "::error::SUPABASE_PROJECT_REF is not set"
            exit 1
          fi
          echo "âœ“ PROD secrets validated"

      - name: Apply migrations to Prod
        if: success()
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "::group::Supabase db push"
          supabase db push \
            --project-ref "$SUPABASE_PROJECT_REF" \
            --db-url "$SUPABASE_DB_URL_PROD"
          echo "::endgroup::"
          echo "âœ“ Migrations applied to PROD"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # PHASE: DEPLOY
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Phase: Deploy"
        if: success()
        run: echo "PHASE=deploy" >> $GITHUB_ENV

      - name: Deploy to Railway
        if: success() && env.RAILWAY_TOKEN != ''
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "::group::Railway deployment"
          railway link --environment production
          railway up --service dragonfly-api --environment production --detach
          echo "::endgroup::"
          echo "âœ“ Railway deployment triggered"

      - name: Deploy to Vercel
        if: success() && env.VERCEL_DEPLOY_WEBHOOK != ''
        run: |
          echo "::group::Vercel deployment"
          curl -fsS -X POST "$VERCEL_DEPLOY_WEBHOOK"
          echo "::endgroup::"
          echo "âœ“ Vercel deployment triggered"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # PHASE: SMOKE TEST
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Phase: Smoke Test"
        if: success()
        run: echo "PHASE=smoke-test" >> $GITHUB_ENV

      - name: Wait for Railway deployment to settle
        if: success()
        run: |
          echo "Waiting 30s for Railway deployment to stabilize..."
          sleep 30

      - name: Post-deploy smoke test
        if: success()
        env:
          SUPABASE_DB_URL_PROD: ${{ secrets.SUPABASE_DB_URL_PROD }}
        run: |
          echo "::group::Production Smoke Test"
          python -m tools.prod_smoke
          echo "::endgroup::"
          echo "âœ“ Production smoke test passed"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # PHASE: COMPLETE
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "Phase: Complete"
        if: success()
        run: echo "PHASE=complete" >> $GITHUB_ENV

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # NOTIFICATIONS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Notify Discord on success
        if: success() && env.DISCORD_WEBHOOK_URL != ''
        run: |
          SHORT_SHA="${GITHUB_SHA:0:7}"
          AUTHOR="${{ github.actor }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"

          curl -fsS -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"ğŸš€ Dragonfly Prod Deployed\",
                \"color\": 5763719,
                \"fields\": [
                  {\"name\": \"Commit\", \"value\": \"[\`${SHORT_SHA}\`](${COMMIT_URL})\", \"inline\": true},
                  {\"name\": \"Author\", \"value\": \"${AUTHOR}\", \"inline\": true},
                  {\"name\": \"Branch\", \"value\": \"main\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"All phases completed successfully\"},
                \"url\": \"${RUN_URL}\",
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK_URL"

      - name: Notify Discord on failure
        if: failure() && env.DISCORD_WEBHOOK_URL != ''
        run: |
          SHORT_SHA="${GITHUB_SHA:0:7}"
          AUTHOR="${{ github.actor }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          FAILED_PHASE="${PHASE:-unknown}"

          curl -fsS -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"âŒ Dragonfly Prod Deploy FAILED\",
                \"description\": \"Pipeline failed during **${FAILED_PHASE}** phase\",
                \"color\": 15548997,
                \"fields\": [
                  {\"name\": \"Failed Phase\", \"value\": \"\`${FAILED_PHASE}\`\", \"inline\": true},
                  {\"name\": \"Commit\", \"value\": \"[\`${SHORT_SHA}\`](${COMMIT_URL})\", \"inline\": true},
                  {\"name\": \"Author\", \"value\": \"${AUTHOR}\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"Click to view logs\"},
                \"url\": \"${RUN_URL}\",
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK_URL"
